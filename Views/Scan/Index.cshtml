@model Reconova.ViewModels.Scan.ScanViewModel

@{
    ViewData["Title"] = "Scan Page";
    int counter = 1;
    int counter1 = 1;
    var canGenerateReport = ViewBag.IsAllowedToGenerateReport ?? false;
}

@section Styles {
    <link rel="stylesheet" href="~/css/tools.css" />
    <link rel="stylesheet" href="~/css/tables.css" />
    <link rel="stylesheet" href="~/css/scanIndex.css" />
}

<div id="topNavButtons" class="mb-4">
    <a asp-action="Tasks" class="btn-back">
        <i class="fas fa-arrow-left me-1"></i> Back
    </a>

    <span id="btnTools" class="selected-btn">
        <i class="fas fa-tools me-1"></i> Scan Tools
    </span>
    <span id="btnHistory">
        <i class="fas fa-history me-1"></i> Scan History
    </span>

     <span id="btnSchedule">
        <i class="fas fa-calendar-alt me-1"></i> Scheduled Scans
    </span>

</div>

<div id="loader" style="
    display:none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    text-align: center;
    padding-top: 20%;
    font-size: 2rem;
    color: #11295a;
    ">
    <i class="fa fa-spinner fa-spin"></i> Loading...
</div>

<section id="scanFormSection">
    <form asp-action="StartScan" method="post" class="text-center">
        <input type="hidden" name="TaskId" value="@Model.TaskId" />

        <div class="d-flex justify-content-center">
            <input id="user_input" class="form-control" type="text" name="Target" placeholder="Enter Domain or IP" value="@Model.Target" readonly required />
            <button id="startScanBtn" class="btn btn-blue" type="submit">Start Scan</button>

            <button id="suggest" class="btn btn-blue" type="button" data-bs-toggle="modal" data-bs-target="#suggestModal">
                <i class="fas fa-star me-1"></i> Suggest
            </button>

            <button id="schedule" class="btn btn-blue" type="button" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                <i class="fas fa-clock me-1"></i> Schedule
            </button>
        </div>

        <section class="d-flex justify-content-center">

            <div id="tools_container" style="margin-top: 1rem;">
                <label><strong>Select Categories:</strong></label>

                <div id="tools">
                    <input type="text" id="categoriesSearch" class="search form-control" placeholder="Search categories..." />
                    @foreach (var item in Model.Categories)
                    {
                        <label class="category-item">
                            <input type="checkbox" class="category-filter" data-category-id="@item.Id" />
                            @item.Name
                        </label>
                    }
                </div>

                <div style="margin-top: 1rem;">
                    <button class="btn btn-blue" type="button" onclick="toggleCategories(true)">Select All</button>
                    <button class="btn btn-danger" type="button" onclick="toggleCategories(false)">Deselect All</button>
                </div>

            </div>

            <div id="tools_container" style="margin-top: 1rem;">
                <label><strong>Select Tool:</strong></label>

                <div id="tools">
                    <input type="text" id="toolsSearch" class="search form-control" placeholder="Search tools..." />
                    @foreach (var item in Model.Tools)
                    {
                        <label title="@item.Description" class="tool-item" data-category-id="@item.CategoryId">
                            <input type="checkbox" name="Tool" value="@item.Name" />
                            @item.Name
                        </label>

                    }
                </div>

            </div>
        </section>
    </form>
</section>


<section id="scanHistorySection" style="display: none;">
    <div class="card">
        <div class="card-header text-center">
            <h5>Scans History</h5>
        </div>
        <div class="card-body">
            <table id="Table" class="table table-hover table-bordered table-striped text-center align-middle shadow-sm rounded">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User</th>
                        <th>Target</th>
                        <th>Command</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ScanResults)
                    {
                        <tr>
                            <td>@counter</td>
                            <td>@item.User?.FirstName @item.User?.LastName</td>
                            <td>@item.Target</td>
                            <td>@item.Command</td>
                            <td>@item.Timestamp.ToLocalTime().ToString("dd-MMMM-yy HH:mm:ss")</td>
                            <td>
                                <a asp-controller="Scan" asp-action="ScanResult" asp-route-id="@item.ScanId">
                                    <i class="fa fa-info-circle"></i>
                                </a>

                                <a href="#" class="deleteScan text-danger" data-id="@item.Id" title="Delete Scan">
                                    <i class="fa fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        counter++;
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (canGenerateReport)
    {
        <input type="hidden" id="taskId" value="@Model.TaskId" />
        <button id="exportBtn" class="btn btn-blue mt-3">Generate Report</button>
    }
</section>


<section id="scanScheduleSection" style="display: none;">
    <div class="card">
        <div class="card-header text-center">
            <h5>Scheduled Scans</h5>
        </div>
        <div class="card-body">
            <table id="ScansTable" class="table table-hover table-bordered table-striped text-center align-middle shadow-sm rounded">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ScheduledScans)
                    {
                        <tr>
                            <td>@counter1</td>
                            <td>@item.Name</td>
                            <td>@item.Time</td>
                            <td>
                                <a href="#"
                                   class="edit-scan"
                                   data-id="@item.Id"
                                   data-name="@item.Name"
                                   data-time="@item.Time.ToString("HH\\:mm")"
                                   data-tools='@Json.Serialize(item.ToolsUsed.Select(t => t.Tool))'
                                   data-bs-toggle="modal" data-bs-target="#editScheduleModal">
                                    <i class="fa fa-edit"></i>
                                </a>

                                <a href="#" class="btn delete-scan-button" data-id="@item.Id" title="Delete Scan">
                                    <i class="fa fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        counter1++;
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Suggest Modal -->
<div class="modal fade" id="suggestModal" tabindex="-1" aria-labelledby="suggestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="suggestModalLabel">
                    <i class="fas fa-stars me-2 text-warning"></i> Get Suggested Tools via AI
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="aiPrompt" class="form-control" placeholder="Describe you task..." />
                    <button class="btn btn-blue" onclick="getSuggestedTools()">Get Tools</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">
            <form asp-action="ScheduleScan" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">
                        <i class="fas fa-clock me-2 text-primary"></i> Schedule Daily Scan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="Target" id="scheduledTarget" />
                    <input type="hidden" name="TaskId" id="scheduledTaskId" value="@Model.TaskId" />

                    <div class="mb-3">
                        <label for="scanName" class="form-label">Schedule Name</label>
                        <input name="Name" id="scanName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="scanTime" class="form-label">Time to run scan</label>
                        <input type="time" name="Time" id="scanTime" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label><strong>Select Tools</strong></label>
                        <div class="d-flex flex-wrap gap-2" id="addScheduledTools">
                            @foreach (var item in Model.Tools)
                            {
                                <div>
                                    <label class="tool-item" title="@item.Description">
                                        <input type="checkbox" name="ToolName" value="@item.Name" />
                                        @item.Name
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-blue">Save Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">
            <form id="editScheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduleModalLabel">
                        <i class="fas fa-edit me-2 text-primary"></i> Edit Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editScanId" />
                    <div class="mb-3">
                        <label for="editScanName" class="form-label">Schedule Name</label>
                        <input id="editScanName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="editScanTime" class="form-label">Time to run scan</label>
                        <input type="time" id="editScanTime" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label><strong>Select Tools</strong></label>
                        <div class="d-flex flex-wrap gap-2" id="editToolsContainer">
                            @foreach (var item in Model.Tools)
                            {
                                <div>
                                    <label class="tool-item" title="@item.Description">
                                        <input type="checkbox" class="editToolCheckbox" value="@item.Name" />
                                        @item.Name
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Update Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>




@section Scripts {
    <script>
        $(document).ready(function () {

            // Live search for categories
            $("#categoriesSearch").on("input", function () {
                const query = $(this).val().toLowerCase();
                $(".category-item").each(function () {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.includes(query));
                });
            });

            // Live search for tools
            $("#toolsSearch").on("input", function () {
                const query = $(this).val().toLowerCase();
                $(".tool-item").each(function () {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.includes(query));
                });
            });


            $('#schedule').click(function () {
                const target = $('#user_input').val().trim();
                const taskId = $('input[name="TaskId"]').val();

                if (!target) {
                    Swal.fire('⚠️', 'Please enter a target before scheduling.', 'warning');
                    return;
                }

                $('#scheduledTarget').val(target);
                $('#scheduledTaskId').val(taskId);
            });

            $(".edit-scan").click(function () {
                const id = $(this).data("id");
                const name = $(this).data("name");
                const time = $(this).data("time");
                const selectedTools = $(this).data("tools");

                $("#editScanId").val(id);
                $("#editScanName").val(name);
                $("#editScanTime").val(time);

                $(".editToolCheckbox").each(function () {
                    const toolName = $(this).val();
                    $(this).prop("checked", selectedTools.includes(toolName));
                });
            });

            $("#editScheduleForm").submit(function (e) {
                e.preventDefault();

                const id = $("#editScanId").val();
                const name = $("#editScanName").val();
                const time = $("#editScanTime").val();
                const selectedTools = [];

                $(".editToolCheckbox:checked").each(function () {
                    selectedTools.push($(this).val());
                });

                $.ajax({
                    url: `/api/schedules/${id}`,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        id: parseInt(id),
                        name,
                        time,
                        toolNames: selectedTools
                    }),
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert("Failed to update schedule.");
                    }
                });
            });

            $(".delete-scan-button").on("click", function () {
                const id = $(this).data("id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This will permanently delete the scheduled scan.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, delete it!",
                    cancelButtonText: "Cancel"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/api/schedules/${id}`,
                            type: "DELETE",
                            success: function () {
                                  Swal.fire({
                                    title: "Deleted!",
                                    text: "The scheduled scan has been deleted.",
                                    icon: "success",
                                    confirmButtonText: "OK"
                                }).then(() => location.reload());
                            },
                            error: function () {
                                Swal.fire({
                                    title: "Error!",
                                    text: "Failed to delete the scheduled scan.",
                                    icon: "error"
                                });
                            }
                        });
                    }
                });
            });



             // Delete Scan
            $(".deleteScan").click(function () {
                const id = $(this).data("id");

                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will permanently delete this scan.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/api/scan/' + id,
                            method: 'DELETE',
                            success: function () {
                                 location.reload();
                            },
                            error: function (xhr) {
                                Swal.fire('Error', xhr.responseText || 'Error deleting scan', 'error');
                            }
                        });
                    }
                });
            });


            initializeDataTable('Table');

            initializeDataTable('ScansTable');

             $('#startScanBtn').on('click', function () {
                const form = $('form[asp-action="StartScan"]');
                const input = $('#user_input').val().trim();

                if (input === '') {
                    Swal.fire('⚠️', 'Please enter a domain or IP address.', 'warning');
                    return;
                }

                $('#loader').show();

                setTimeout(function () {
                    form.submit();
                }, 100);
            });

           $('#btnTools, #btnHistory, #btnSchedule').on('click', function () {
                $('#btnTools, #btnHistory, #btnSchedule').removeClass('selected-btn');
                $(this).addClass('selected-btn');
            });

            $('#btnTools').on('click', function () {
                $('#scanFormSection').show();
                $('#scanHistorySection, #scanScheduleSection').hide();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            $('#btnHistory').on('click', function () {
                $('#scanFormSection, #scanScheduleSection').hide();
                $('#scanHistorySection').show();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            $('#btnSchedule').on('click', function () {
                $('#scanFormSection, #scanHistorySection').hide();
                $('#scanScheduleSection').show();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            $('#exportBtn').click(function () {
                const taskId = $('#taskId').val();

                if (!taskId) {
                    alert('Please enter a Task ID.');
                    return;
                }

                const requestData = {
                    taskId: parseInt(taskId)
                };

                $.ajax({
                    url: '/api/report/export',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    xhrFields: {
                        responseType: 'blob' 
                    },
                    success: function (data, status, xhr) {
                        const blob = new Blob([data], { type: 'application/pdf' });

                        const fileName = xhr.getResponseHeader('Content-Disposition')
                            ?.split('filename=')[1]
                            ?.replaceAll('"', '') || 'ScanResults_Report.pdf';

                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        link.remove();
                    },
                    error: function (xhr) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            alert("Error: " + reader.result);
                        };
                        reader.readAsText(xhr.responseText);
                    }
                });
            });
        });

        function toggleCategories(selectAll) {
            $('.category-filter').prop('checked', selectAll);
            filterToolsByCategories();
        }

        async function getSuggestedTools() {
            var loader = $('#loader');
            var prompt = $('#aiPrompt').val();
            if (!prompt.trim()) {
                Swal.fire('⚠️', 'Please enter a prompt before submitting.', 'warning');
                return;
            }

            try {
                loader.show();

                const response = await fetch('/api/ai/suggested-tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const data = await response.json();

                Swal.fire({
                    title: 'Suggested Tools',
                    html: `<ul>${data.tools.map(t => `<li>${t}</li>`).join('')}</ul>`,
                    icon: 'info',
                    confirmButtonColor: '#11295a'
                });
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            } finally {
                loader.hide();
            }
        }

        function filterToolsByCategories() {
            const selectedCategoryIds = $('.category-filter:checked').map(function () {
                return $(this).data('category-id');
            }).get();

            if (selectedCategoryIds.length === 0) {
                $('.tool-item').show();
            } else {
                $('.tool-item').each(function () {
                    const toolCategoryId = $(this).data('category-id');
                    if (selectedCategoryIds.includes(toolCategoryId)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
        }

        // Trigger filtering on category checkbox change
        $(document).on('change', '.category-filter', filterToolsByCategories);

        // Allow only one tool to be selected
        $(document).on('change', 'input[name="Tool"]', function () {
            if ($(this).is(':checked')) {
                // Uncheck and disable all others
                $('input[name="Tool"]').not(this).prop('checked', false).prop('disabled', true);
            } else {
                // If unchecked, re-enable all
                $('input[name="Tool"]').prop('disabled', false);
            }
        });

    </script>
}
