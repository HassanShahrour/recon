@model Reconova.ViewModels.Users.ProfileViewModel

@{
    ViewData["Title"] = "My Profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" />
    <link rel="stylesheet" href="~/css/post.css" />
}

<div class="container">
    @await Html.PartialAsync("_UserProfileCard", Model.User)


    <div class="d-flex gap-2 mt-3">
        <a class="btn btn-blue" asp-action="Edit">Edit</a>
        <a class="btn btn-secondary" asp-controller="Post" asp-action="Create">Create a Post</a>
    </div>

    <div class="posts-container">
        <div class="posts-grid">
            @foreach (var post in Model.Posts)
            {
                @await Html.PartialAsync("_PostCard", post)
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const baseUrl = '@Url.Content("~/")';

        $(document).ready(function () {
            $('.comment-btn').on('click', function () {
                const postId = $(this).data('post-id');
                const commentSection = $(`#comments-${postId}`);
                commentSection.slideToggle(200);

                const list = $('#comment-list-' + postId);
                list.scrollTop(list[0].scrollHeight);
            });

        });


        // Like Button Click
        $('.like-btn').click(function (e) {
            e.preventDefault();

            const $btn = $(this);
            const postId = $(this).data('post-id');

            $.ajax({
                url: '/api/Like/Toggle',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ PostId: postId }),
                success: function (res) {
                    $btn.find('.like-count').text(res.likeCount);
                    $btn.toggleClass('liked');
                }
            });
        });

        // Add Comment
        function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value;

            if (!content.trim()) return;

            $.ajax({
                url: '/api/Comment/Add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ PostId: postId, Content: content }),
                success: function (res) {
                    const avatarUrl = res.userProfilePhotoPath
                        ? baseUrl + res.userProfilePhotoPath.replace(/^~\//, '')
                        : baseUrl + 'images/account-bg.jpg';

                    const userName = res.userFirstName || 'You';

                    const commentHtml = `
                        <div class="comment-item">
                            <img src="${avatarUrl}" alt="${userName}" class="comment-avatar" />
                            <div class="comment-bubble">
                                <strong>${userName}</strong><br />
                                <span>${res.content}</span>
                            </div>
                        </div>`;

                    const list = $(`#comment-list-${postId}`);
                    list.prepend(commentHtml);
                    input.value = '';

                    const counter = $(`.comment-btn[data-post-id="${postId}"] .comment-count`);
                    const newCount = parseInt(counter.text()) + 1;
                    counter.text(newCount);
                }
            });
        }


    </script>
}
